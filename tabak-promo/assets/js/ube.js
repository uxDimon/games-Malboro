!function (oe) { "use strict"; function e(e) { return navigator && navigator.userAgent && e && e.test(navigator.userAgent) } oe = oe && oe.hasOwnProperty("default") ? oe.default : oe; var s = e(/(ipod|iphone|ipad)/i), re = e(/android/i), se = e(/(XiaoMi|MiuiBrowser|YaSearch|YaApp)/i); function v() { $.ube || ($.ube = {}), $.ube.host || ($.ube.host = "https://ube-test.pmsm.org.ru"), $.ube.leadHost || ($.ube.leadHost = "https://lead.pmsm.org.ru") } oe.fn.ubeAutocomplete = function (n) { var t = oe(this), e = { minLength: 1, open: function () { s && oe(".ui-autocomplete").off("menufocus hover mouseover"), n.classes && n.classes["ui-autocomplete"] && "max-height" == n.classes["ui-autocomplete"] && oe(".ui-autocomplete.max-height").css({ maxHeight: "250px", overflowY: "scroll" }) } }, a = {}, i = oe(this).attr("data-position"); "off" !== i && (e.position = "top" === i ? { my: "left bottom", at: "left top", collision: "flip" } : { my: "left top", at: "left bottom", collision: "flip" }); var o = oe(this).attr("data-target") ? oe(oe(this).attr("data-target")) : oe(this).closest("form"); function r(e) { t.data("source", e) } return o && 1 === o.length && (e.appendTo = o), n.source && (Array.isArray(n.source) ? r(n.source) : "function" == typeof n.source && (a.source = function (e, t) { n.source(e, function (e) { r(e), t(e) }) })), oe(this).autocomplete(oe.extend(e, n, a)).disableBrowserAutocomplete() }, oe.fn.disableBrowserAutocomplete = function () { return this.each(function () { var e = oe(this); return "off" !== e.attr("autocomplete") && e.attr("autocomplete", "random-" + (new Date).getTime()), e }) }; function ue(e, t, n) { if (e && void 0 === t) { var a = ("; " + document.cookie).split("; " + e + "="); return 2 === a.length ? a.pop().split(";").shift() : void 0 } e && null === t ? document.cookie = encodeURIComponent(e) + "=" + encodeURIComponent(t) + "; expires=" + new Date(0).toUTCString() + "; path=/; secure;" : e && (n = n || "Fri, 31 Dec 9999 23:59:59 GMT", document.cookie = encodeURIComponent(e) + "=" + encodeURIComponent(t) + "; expires=" + n + "; path=/; secure;") } var u = "ube_face_before", t = "UBE_COOKIE_POLICY", n = "UBE_COOKIE_CHECK", l = "UBE_SESSION_KEY_REG", le = "UBE_AGE_VERIFIED_TOKEN", ce = "UBE_AGE_VERIFIED", f = "UBE_WIDGET_SESSION_KEY", h = "UBE_WIDGET_REGISTER", p = "UBE_WIDGET_LOGIN"; function de(e, t, n) { try { dataLayer.push({ event: "aevent", ecategory: e || "UBE", eaction: t, elabel: n, interactionType: "False" }) } catch (e) { } try { !function (e, t, n) { try { ga("send", "event", "UBE", e, t, n) } catch (e) { } }(e, t) } catch (e) { } } function fe(e) { try { dataLayer.push({ userid: e, userId: e }) } catch (e) { } try { ga("set", "userId", e) } catch (e) { } try { window.gibSetUserIDCallback(function () { return e }) } catch (e) { } } var m, b, g, y, w, o, he = ["allocationCode", "ref", "partner"]; function k(e) { oe.ube && oe.ube.toggleLoader && oe.ube.toggleLoader(e) } function C(e) { oe.ube && oe.ube.showPopup ? oe.ube.showPopup(e) : alert(e) } function c(e) { oe.ube && oe.ube.toggleLoader && oe.ube.toggleLoader(e) } function S(n, a, i, o) { var e = oe.ube.host; function r() { var t, e, n = (t = a, Object.keys(w).find(function (e) { return w[e] === t })); n ? i("https://".concat(n, "/?")) : (e = "Ошибка создания персональной ссылки", oe.ube && oe.ube.showPopup ? oe.ube.showPopup(e) : alert(e)) } if (c(!0), o = o || 3, !n || "" === n) return r(), 0; oe.ajax({ url: e + "/api/session/createHash", headers: { "ube-session-key": n }, data: { allocationCode: a }, success: function (e) { if (c(!1), !0 === e.result && e.value) i((t = e.value) && !t.startsWith("http") ? "https://" + t : t); else { if (!(1 < o)) return r(); S(n, a, i, o - 1) } var t }, error: function () { if (!(1 < o)) return c(!1), r(); S(n, a, i, o - 1) } }) } function r(e, t, n) { oe(".loyalty-history").remove(); var a = oe(t), i = a.find(".loyalty-history_holder"), o = a.find(".loyalty-history_entry").clone(); i.empty(); function r(e) { var t = o.clone(), n = parseInt(e.points) || 0, a = "Баллов"; n % 10 == 1 ? a = "Балл" : n % 10 < 5 && 1 < n % 10 && (a = "Балла"), e.deactivated && e.deactivatedText && !e.active ? (t.find(".loyalty-history_label").text("У вас списаны баллы"), t.find(".loyalty-history_date").text(e.deactivated), t.find(".loyalty-history_description").text(e.deactivatedText), t.find(".loyalty-history_points").text("- " + n + " " + a), i.append(t)) : e.created && e.text && (t.find(".loyalty-history_label").text("Вам начислены баллы"), t.find(".loyalty-history_date").text(e.created), t.find(".loyalty-history_description").text(e.text), t.find(".loyalty-history_points").text("+ " + n + " " + a), i.append(t)) } var s = a.find(".loyalty-history_button a"); function u() { s.hide(), n.slice(10).forEach(r) } s.click(function (e) { return e.preventDefault(), setTimeout(u, 300), !1 }), 0 < n.length ? (n.slice(0, 10).forEach(r), 10 < n.length ? s.show() : s.hide(), a.find(".loyalty-history_empty").hide()) : (s.hide(), a.find(".loyalty-history_empty").show()), e.html(a) } function d(e) { if (!e) return e; if ("string" == typeof e || e instanceof String) { var t = (e = A(e)).split("-"), n = parseInt(t[0]), a = o[parseInt(t[1]) - 1], i = parseInt(t[2]); return n === (new Date).getFullYear() ? "".concat(i, " ").concat(a) : "".concat(i, " ").concat(a, " ").concat(n) } return e } function A(e) { return e && ("string" == typeof e || e instanceof String) && 10 === e.length && (e += "T23:59:59.999Z"), e } function T(e) { e.html("<p>Ошибка при получении данных</p>") } function x(e, t) { if (!(e instanceof t)) throw new TypeError("Cannot call a class as a function") } function a(e, t) { for (var n = 0; n < t.length; n++) { var a = t[n]; a.enumerable = a.enumerable || !1, a.configurable = !0, "value" in a && (a.writable = !0), Object.defineProperty(e, a.key, a) } } function V(e, t, n) { return t && a(e.prototype, t), n && a(e, n), e } function E(t, e) { var n, a = Object.keys(t); return Object.getOwnPropertySymbols && (n = Object.getOwnPropertySymbols(t), e && (n = n.filter(function (e) { return Object.getOwnPropertyDescriptor(t, e).enumerable })), a.push.apply(a, n)), a } function pe(i) { for (var e = 1; e < arguments.length; e++) { var o = null != arguments[e] ? arguments[e] : {}; e % 2 ? E(Object(o), !0).forEach(function (e) { var t, n, a; t = i, a = o[n = e], n in t ? Object.defineProperty(t, n, { value: a, enumerable: !0, configurable: !0, writable: !0 }) : t[n] = a }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(i, Object.getOwnPropertyDescriptors(o)) : E(Object(o)).forEach(function (e) { Object.defineProperty(i, e, Object.getOwnPropertyDescriptor(o, e)) }) } return i } function i(e, t) { if ("function" != typeof t && null !== t) throw new TypeError("Super expression must either be null or a function"); e.prototype = Object.create(t && t.prototype, { constructor: { value: e, writable: !0, configurable: !0 } }), t && F(e, t) } function O(e) { return (O = Object.setPrototypeOf ? Object.getPrototypeOf : function (e) { return e.__proto__ || Object.getPrototypeOf(e) })(e) } function F(e, t) { return (F = Object.setPrototypeOf || function (e, t) { return e.__proto__ = t, e })(e, t) } function I(e) { if (void 0 === e) throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); return e } function D(o) { var r = function () { if ("undefined" == typeof Reflect || !Reflect.construct) return !1; if (Reflect.construct.sham) return !1; if ("function" == typeof Proxy) return !0; try { return Date.prototype.toString.call(Reflect.construct(Date, [], function () { })), !0 } catch (e) { return !1 } }(); return function () { var e, t, n, a, i = O(o); return t = r ? (e = O(this).constructor, Reflect.construct(i, arguments, e)) : i.apply(this, arguments), n = this, !(a = t) || "object" != typeof a && "function" != typeof a ? I(n) : a } } function me(e) { return function (e) { if (Array.isArray(e)) return _(e) }(e) || function (e) { if ("undefined" != typeof Symbol && Symbol.iterator in Object(e)) return Array.from(e) }(e) || function (e, t) { if (!e) return; if ("string" == typeof e) return _(e, t); var n = Object.prototype.toString.call(e).slice(8, -1); "Object" === n && e.constructor && (n = e.constructor.name); if ("Map" === n || "Set" === n) return Array.from(e); if ("Arguments" === n || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _(e, t) }(e) || function () { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.") }() } function _(e, t) { (null == t || t > e.length) && (t = e.length); for (var n = 0, a = new Array(t); n < t; n++)a[n] = e[n]; return a } function j(e, t) { var n = t.get(e); if (!n) throw new TypeError("attempted to get private field on non-instance"); return n.get ? n.get.call(e) : n.value } function P(e, t, n) { var a = t.get(e); if (!a) throw new TypeError("attempted to set private field on non-instance"); if (a.set) a.set.call(e, n); else { if (!a.writable) throw new TypeError("attempted to set read only private field"); a.value = n } return n } oe.fn.ubeFace = function (e, o) { var r = oe(this).first(), f = r.find("form"); v(); oe.ube.host; function h(i, e) { !function a(i, o, r, s) { var e = oe.ube.host; s = s || 3, oe.ajax({ url: e + "/api/face/token", method: "post", data: JSON.stringify({ token: i, captureType: o }), contentType: "application/json; charset=UTF-8" }).done(function (e) { k(!1), r(e) }).fail(function (e, t, n) { 0 < --s ? a(i, o, r) : C("Ошибка при валидации результатов ACS API") }) }(i, e, function (e) { var t, n, a; e && e.ga && (e.ga instanceof Array ? e.ga.forEach(function (e) { de(e.category, e.action, e.label) }) : e.ga.action && de((t = e.ga).category, t.action, t.label)), e && e.data && (e.data.sessionKey && ((n = new Date).setTime(n.getTime() + 3e6), a = "expires=" + n.toUTCString(), ue(l, e.data.sessionKey, a), ue(u, !0), ue(le, i, a), ue(ce, "face", a)), o.onSubmissionSuccess && o.onSubmissionSuccess(e.data)) }) } function t() { r.find(".ube-visibility-show-for-method, .ube-visibility-show-for-megafonMethod, .ube-visibility-show-for-documentMethod").hide(), r.find(".ube-visibility-show-for-faceMethod").show(), function a(i, o) { var e = oe.ube.host; o = o || 3, oe.getJSON(e + "/api/face/token").done(function (e) { k(!1), e.access_token && e.next_validation_endpoint ? (de("AV", "AV-FR-Token-Received", "Token-Received"), i(e.access_token, e.next_validation_endpoint)) : 0 < --o ? a(i) : (de("AV", "AV-FR-Get-Token-Error", "Get-Token-Error-ACS"), C("Ошибка в ответе сервиса ACS API")) }).fail(function (e, t, n) { 0 < --o ? a(i) : (de("AV", "AV-FR-Get-Token-Error", "Get-Token-Error-UBE"), C("Ошибка в ответе сервиса ACS API")) }) }(n) } function p(e) { var t = e.split(";"), n = t[0].split(":")[1]; return function (e, t, n) { t = t || "", n = n || 512; for (var a = atob(e), i = [], o = 0; o < a.length; o += n) { for (var r = a.slice(o, o + n), s = new Array(r.length), u = 0; u < r.length; u++)s[u] = r.charCodeAt(u); var l = new Uint8Array(s); i.push(l) } return new Blob(i, { type: t }) }(t[1].split(",")[1], n) } function n(e, t) { oe(".ube-face-error").hide(), oe(".ube-face-container").show(); var i = e, n = t, a = r.find(".ube-camera-container"), s = r.find(".ube-camera-render"), u = r.find(".ube-camera-capture"), l = r.find(".ube-camera-fallback"); if (s.data("init") || !i || !n) return !1; function c(e, a) { k(!0), de("AV", "AV-FR-Submit", "Submit-Photo"), oe.ajax({ url: n, data: e, type: "POST", processData: !1, cache: !1, dataType: "json", contentType: "application/octet-stream", crossDomain: !0, headers: { Authorization: "Bearer " + i, "X-ACS-PICTURE-MODE": "stream" }, error: function () { k(!1), de("AV", "AV-FR-Failed", "Submit-Photo-Failed-Technical") }, success: function (e) { var t, n; k(!1), e && ("SUCCESS" !== e.status_code || window.bad ? "DOCUMENT" === e.next_validation_type || window.bad ? (a && a(), t = "limit", n = e, o.onSubmissionError && o.onSubmissionError(t, n), de("AV", "AV-FR-Failed", "Submit-Photo-Failed-Second"), de("AV", "AV-FR-Failed-Details", e.error_message)) : e.error_message && (de("AV", "AV-FR-Failed", "Submit-Photo-Failed-First"), de("AV", "AV-FR-Failed-Details", e.error_message), C("Ой! Похоже, что вы выглядите слишком молодо.<br><br> <small>Возможно вы не выполнили одно из условий. В любом случае стоит попробовать еще раз, чтобы изображение получилось более чётким, не засвеченным и не слишком затемненным.</small>")) : (a && a(), h(i))) } }) } function d() { de("AV", "AV-FR-Mode", "AV-Upload"), a.removeClass("ube-camera-option-capture").addClass("ube-camera-option-upload"), l.show(), s.hide(); var n = oe('<input type="file" accept="image/*" capture="user" style=\'width:0;height:0;position:absolute;\'/>').appendTo("body"); n.off("change").change(function () { var e = new FileReader; e.addEventListener("load", function () { var e = this.result, t = p(e); n.val(""), n.wrap("<form>").closest("form").get(0).reset(), n.unwrap(), c(t) }, !1), e.readAsDataURL(this.files[0]) }), u.add(".ube-camera-option-upload").off("click").click(function (e) { return e.preventDefault(), n.click(), !1 }) } s.data("init", !0), function () { if (se) return d(); l.hide(), s.html("<video></video>").show(), a.addClass("ube-camera-option-capture").removeClass("ube-camera-option-upload"); var o, r = s.find("video")[0]; navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? (r.setAttribute("autoplay", ""), r.setAttribute("muted", ""), r.setAttribute("playsinline", ""), o = function () { r.pause(), r.src = "", r.srcObject && r.srcObject.getTracks().forEach(function (e) { e.stop() }), s.html(""), s.data("init", !1) }, f.on("stopVideoCapture", function () { o() }), navigator.mediaDevices.getUserMedia({ audio: !1, video: { facingMode: "user" } }).then(function (e) { r.srcObject = e, de("AV", "AV-FR-Mode", "AV-Stream"), u.off("click").click(function (e) { e.preventDefault(); var t = oe("<canvas style='visibility:hidden;display:block;position: absolute;top:-2000px;left:-2000px'></canvas>").appendTo("body")[0]; t.width = r.videoWidth, t.height = r.videoHeight, t.getContext("2d").drawImage(r, 0, 0); var n = t.toDataURL("image/png"), a = p(n), i = oe('<form style=\'position: absolute;top:-2000px;left:-2000px;display: block;\'><input type="text" id="filename" name="filename" /></form>'); return i.appendTo("body"), new FormData(i[0]).append("image", a), c(a, o), !1 }) }).catch(function (e) { d() })) : d() }() } var a, i, s = o.isTemplatePreloaded; o.onSubmissionSuccess; s ? t() : (a = oe.ube.host, i = o.template || a + "/template/" + e, r.load(i, t)) }, oe.fn.ubeFileToBase64 = function (e) { var t, n, a, r, i, o = oe(this), s = e.callback, u = e.previewSelector; function l(e) { t.data("base64", e), a && a.attr("src", e), n && n() } function c(e) { e.addEventListener("load", function () { l(e.result) }, !1) } n = s, a = u, (i = (t = o) && t[0] && t[0].files ? t[0].files[0] : null) ? ((r = new FileReader).onload = function (e) { try { var o = new Image; o.onload = function (e) { try { var t = document.createElement("canvas"), n = 1600, a = o.width, i = o.height; i < a ? n < a && (i *= n / a, a = n) : n < i && (a *= n / i, i = n), t.width = a, t.height = i, t.getContext("2d").drawImage(o, 0, 0, a, i), l(t.toDataURL("image/jpeg")) } catch (e) { c(r) } }, o.src = e.target.result } catch (e) { c(r) } }, r.readAsDataURL(i)) : t.data("base64", null) }, m = window.location.hostname, b = window.location.pathname, g = "scanpack", y = "premium-one", w = { "parliament.ru": "CTBPL", "marlboro.ru": "CTBML", "mrphilipmorris.ru": "CTBPM", "bondstreet.ru": "CTBBS", "lmlab.ru": "CTBLM", "nextlook.ru": "CTBNX" }, oe.ubeLink = function (e) { var t, n = e || {}, a = n.allocationCode, i = n.sessionKey, o = n.utmSource, r = n.utmMedium, s = n.utmCampaign, u = n.utmContent, l = n.utmTerm, c = n.callback, d = n.redirect; a && "" !== a || (a = (t = (t = Object.keys(w).find(function (e) { return m.endsWith(e) })) || Object.keys(w).find(function (e) { return b.includes(e.replace(".ru", "")) })) ? w[t] : "CTBPL"), s && "" !== s || (s = m.startsWith("qr.") ? b : m.endsWith("premium.one") && b.startsWith("/qr/") ? b.replace(/^\/qr\/([^\/]+)\/(.*[^\/])\/?\/?$/, "$2") : b.replace(/^\/?(.*[^\/])\/?$/, "$1")), o && "" !== o || (o = m.startsWith("qr.") || m.endsWith("premium.one") && b.startsWith("/qr/") || !m.endsWith("premium.one") ? g : y), r && "" !== r || (r = "web"), i && "" !== i || (i = ue(f)), v(); oe.ube.host; de("UBE-Link", "UBE-Link-" + a, a), S(i, a, function (e) { var t = e + "&utm_source=".concat(o, "&utm_medium=").concat(r, "&utm_campaign=").concat(s); u && "" !== u && (t += "&utm_content=".concat(u)), l && "" !== l && (t += "&utm_term=".concat(l)), d && "" !== d && (t += "&redirect=".concat(encodeURIComponent(d))), c ? c(e, t) : window.location.href = t }) }, o = ["Января", "Февраля", "Марта", "Апреля", "Мая", "Июня", "Июля", "Августа", "Сентября", "Октября", "Ноября", "Декабря"], oe.fn.ubeLoyalty = function (e) { if (!e || "" === e) throw new Error("loyalty requires sessionKey as parameter"); var t, n, a, i = oe(this).first(); v(), oe.get(oe.ube.host + "/template/loyalty-history").then(function (e) { t = e, n && t && r(i, t, n) }).catch(function (e) { T(i) }), a = e, oe.get(oe.ube.host + "/api/session/get?attributes=1&sessionKey=" + a).then(function (e) { (n = function (e) { if (e && e.attributes) { var t = e.attributes.loyaltyHistory || [], a = [], i = []; return t.sort(function (e, t) { var n = A(e.deactivated || e.created), a = A(t.deactivated || t.created); return n < a ? 1 : n !== a || e.deactivated && !t.deactivated ? -1 : !e.deactivated && t.deactivated ? 1 : 0 }).forEach(function (e) { var t = 0 < [1, "1", !0, "true", "True", "TRUE", "Yes", "YES", "TRUE"].indexOf(e.active), n = e.id + (t ? "1" : "0"); e.active = t, e.created = d(e.created), e.deactivated = d(e.deactivated), e.points = parseInt(e.points), -1 === a.indexOf(n) && (a.push(n), i.push(e)) }), i } return [] }(e)) && t && r(i, t, n) }).catch(function (e) { T(i) }) }, oe.fn.ubeMask = function (i, o, r) { return this.each(function () { var e, n = oe(this), t = i || oe(this).attr("data-mask"), a = o || oe(this).attr("placeholder"); t && 0 < t.length && (n.addClass("ube-field-masked").attr("data-mask", t), e = function (e, t) { return re && n.attr("inputmode", "numeric"), oe.ube && oe.ube.fieldMask ? oe.ube.fieldMask(n, e, t) : n.inputmask ? n.inputmask(e, t) : n.mask(e, t) }, a && 0 < a.length ? (n.attr("data-placeholder", a), e(t, { placeholder: r || a })) : e(t, {})) }) }, $.fn.ubeScanpackFace = function (e, t) { var n = $(this).first(); if (n && n.length, !e || "" === e) return n.html("UBE - Не указан параметр name"); e = e.replace("-reg", "-face"), n.ubeFace(e, { isTemplatePreloaded: !1, onSubmissionSuccess: function (e) { t(!0, e) }, onSubmissionError: function (e) { n.find(".ube-hide-on-fail").hide(), n.find(".ube-show-on-fail").show(), t(!1, e) } }) }, oe.fn.ubeScanpackLogin = function (s, u) { var e = oe(this).first(); if (e && e.length, !s || "" === s) return e.html("UBE - Не указан параметр name"); var t = s.replace("-reg", "-phone-send"), a = s.replace("-reg", "-phone-check"); e.empty(); var l = oe('<div class="ube-form-phone-send"></div>').appendTo(e), c = oe('<div class="ube-form-phone-check"></div>').hide().appendTo(e), d = oe('<div class="ube-form-register"></div>').hide().appendTo(e); l.show().ube(t, { data: { phone: "" }, isTemplatePreloaded: !1, onSubmissionSuccess: function (e, t, n) { "success" === n.event && function (e, o) { l.hide(); var r = ue(h) || ue(p) ? "ReturningUser" : "NewUser"; c.show().ube(a, { sessionKey: e, isTemplatePreloaded: !1, loadFormDataFromSession: !0, data: { phone: o }, onSubmissionSuccess: function (e, t, n) { switch (n.event) { case "cancel": case "close": c.hide(), l.show(), oe(".ube-phone-send-form [name=phone]").focus(); break; case "verified": de("PhoneConf", "ToRegistration", r), a = n.data.sessionKey, i = o, c.hide(), d.show().ube(s, { isTemplatePreloaded: !1, sessionKey: a, data: { phone: i }, onSubmissionSuccess: function (e, t, n) { switch (n.event) { case "alreadyVerified": case "registered": oe("#popup-content").hide(), oe("#registration-content").hide(), ue(h, "Y"), ue(f, n.data.sessionKey, null); n.event, n.data.sessionKey; u("registered", n); break; case "2optin": alert("UBE - Ошибка конфигурации формы. Требуется включить предварительное подтверждение по sms") } } }); break; case "loginSuccess": de("PhoneConf", "Login", r), ue(p), ue(f, n.data.sessionKey, null); n.event, n.data.sessionKey; u(n.event, n) }var a, i } }) }(n.data.sessionKey, n.data.phone) } }) }, oe.scrollToElement = function (e) { if (!e) return !1; var t = oe(e); if (0 === t.length) return !1; var n = t.first(); return t.each(function () { oe(this).offset().top < n.offset().top && (n = oe(this)) }), n.focus() }, oe.fn.ubeTimer = function (a, e, i) { var t, o, r = oe(this); function s() { t && (clearInterval(t), clearTimeout(t), t = void 0) } function n() { var e = " секунд", t = --o % 10, n = o % 100; (n < 10 || 20 < n) && (1 == t ? e = i ? " секунду" : " секунда" : 1 < t && t < 5 && (e = " секунды")), r.text(o + e), o <= 0 && (s(), a && a()) } return { start: function () { s(), o = e || 60, n(), t = setInterval(n, 1e3) }, stop: s } }, oe.fn.ubeTraverseEnter = function () { var i = oe(this), o = 0 < i.find(".ube-traverse-enter").length ? ".ube-traverse-enter" : "input"; i.find(o).keydown(function (e) { var t = i.find(o + ":visible"); if (13 === e.which) { var n = t.index(this) + 1, a = t.length; if (oe(this).is(".ube-wizard-enter-next")) return i.trigger("ubeNext"), e.preventDefault(), !1; if (n < a) return t.eq(n).focus(), e.preventDefault(), !1 } }) }, oe.fn.ubeValidate = function (e, t, n) { var a = oe(this).first().data("ube"); a && a.validateAllFields(t, n, a.appendChildrenKeys(e)) }, oe.fn.ubeWallet = function (n, e, a, i) { var t, o = oe(this); if (!n || "" === n) throw new Error("wallet requires sessionKey as parameter"); v(), s || re ? (e("mobile"), t = n, oe.ajax({ url: oe.ube.host + "/api/referral/link", headers: { "ube-session-key": t } }).then(function (e) { e && e.value ? o.attr("href", e.value).attr("download", !0).click(function () { a("mobile") }) : i("Отсутствует ссылка на скачивание карты. Попробуйте позже или обратитесь в Контакт Центр") }).catch(function (e) { i("Ошибка при запросе карты. Попробуйте позже или обратитесь в Контакт Центр") })) : (e("desktop"), o.off("click").click(function (e) { var t; return e.preventDefault(), t = n, oe.ajax({ url: oe.ube.host + "/api/referral/link/send", headers: { "ube-session-key": t } }).then(function (e) { e ? !1 === e.value ? i("Отсутствует ссылка на скачивание карты. Попробуйте позже или обратитесь в Контакт Центр") : !1 === e.phone ? i("Отсутствует номер телефона в профиле. Для отправки СМС заполните его") : !0 === e.value ? a("desktop") : i("Ошибка при отправке карты. Попробуйте позже или обратитесь в Контакт Центр") : i("Ошибка при отправке карты. Попробуйте позже или обратитесь в Контакт Центр") }).catch(function (e) { i("Ошибка при отправке карты. Попробуйте позже или обратитесь в Контакт Центр") }), !1 })) }, String.prototype.includes || (String.prototype.includes = function (e, t) { return "number" != typeof t && (t = 0), !(t + e.length > this.length) && -1 !== this.indexOf(e, t) }), Array.prototype.includes || Object.defineProperty(Array.prototype, "includes", { enumerable: !1, value: function (t) { return 0 < this.filter(function (e) { return e == t }).length } }), Array.prototype.flat || Object.defineProperty(Array.prototype, "flat", { value: function (e) { var n = 0 < arguments.length && void 0 !== e ? e : 1; return this.reduce(function (e, t) { return e.concat(Array.isArray(t) && 1 < n ? t.flat(n - 1) : t) }, []) } }); function M(e, t) { x(this, M), this.host = e, this.path = t } var R = new WeakMap, U = new WeakMap, K = new WeakMap, N = new WeakMap, L = function () { function n(e, t) { x(this, n), R.set(this, { writable: !0, value: void 0 }), U.set(this, { writable: !0, value: void 0 }), K.set(this, { writable: !0, value: ["locationId", "entity", "socialId", "socialKey", "phoneCodeSentAt", "phoneCodeSent", "emailCodeSentAt", "emailCodeSent", "phoneValidatedValue", "emailValidatedValue", "method", "profileId", "token", "tokenUrl", "externalId", "utmCampaign", "utmContent", "utmSource", "utmMedia", "isPhoneCross", "isEmailCross", "popup", "mobileTelephoneVerifiedCode", "emailVerifiedCode", "phoneVerifiedLabel", "emailVerifiedLabel", "isEmailChangedOneMonth", "isPhoneChangedOneMonth"] }), N.set(this, { writable: !0, value: ["firstName", "lastName", "email"] }), P(this, R, e), P(this, U, t), this.getDOMField = this.getDOMField.bind(this), this.createFieldIfAbsent = this.createFieldIfAbsent.bind(this), this.setDOMFieldLabel = this.setDOMFieldLabel.bind(this), this.setDOMFieldValue = this.setDOMFieldValue.bind(this), this.getDOMFieldValue = this.getDOMFieldValue.bind(this) } return V(n, [{ key: "createFieldIfAbsent", value: function () { var e = this.key; 0 <= j(this, K).indexOf(e) && 0 === this.getDOMField().length && this.container.find("form").append('<input type="hidden" name="' + e + '"/>') } }, { key: "getDOMField", value: function (e) { var t, n = this.container, a = this.key, i = this.typ; return e && 0 < e.length ? t = n.find("[name='" + a + "']").filter(e) : "radio" === i && 0 !== (t = n.find("[name='" + a + "']:checked")).length || (t = n.find("[name='" + a + "']")), t } }, { key: "setDOMFieldLabel", value: function (e) { var t = this.key, n = e; if ("gender" === t) switch (e) { case "male": n = "Мужской"; break; case "female": n = "Женский"; break; default: n = "" } else "phone" === t || "phoneValidatedValue" === t ? 10 === ("" + n).length && (n = (n + "").replace(/^(\d{3})(\d{3})(\d{2})(\d{2})$/, "+7 ($1) $2-$3-$4")) : "birthDate" === t && (n = (n || "").replace(/^.*(\d{2})[^0-9]*(\d{2})[^0-9]*(\d{4}).*$/, "$1.$2.$3").replace(/^.*(\d{4})[^0-9]*(\d{2})[^0-9]*(\d{2}).*$/, "$3.$2.$1")); this.container.find(".ube-value-label-" + t).html(n) } }, { key: "setDOMFieldValue", value: function (e) { function t(e, t) { "radio" === i ? 0 < o("[type=radio]").length ? t ? o("[value='" + t + "']").prop("checked", !0) : o().prop("checked", !1) : o().val(t) : "checkbox" === i ? o().prop("checked", t) : -1 < ["locationId", "cigaretteType", "cigaretteTypeExt", "cigaretteBrand", "cigaretteBrandExt"].indexOf(e) ? o().attr("data-value", t) : (s(), o().val(t)) } var n = this.container, a = this.key, i = this.typ, o = this.getDOMField, r = j(this, R).options, s = this.createFieldIfAbsent; r.setFieldValue ? r.setFieldValue(a, e, t) : t(a, e); var u = n.find(".ube-value-" + a); u.is("input[type=checkbox]") ? u.prop("checked", e) : u.html(e), this.setDOMFieldLabel(e) } }, { key: "getDOMFieldValue", value: function (e) { var t = this.typ, n = this.getDOMField(); if (n && 0 !== n.length) { if ("checkbox" === t) return n.is(":checked"); if ("select" === t && "url" === this.component.dataSrc) return n.attr("data-value"); if ("phoneNumber" === t) return n.val() ? n.val().replace(/[^0-9]/g, "").replace(/^([78])([0-9]{10}).*$/, "$2") : void 0; if ("file" === t) return n.data("base64"); var a = n.attr("data-value") || n.val(); return a && j(this, N).includes(this.key) && (a = a.trim()), a } return e } }, { key: "container", get: function () { return j(this, R).container } }, { key: "key", get: function () { return j(this, U) } }, { key: "component", get: function () { return j(this, R).component(this.key) } }, { key: "typ", get: function () { return this.component.type } }]), n }(), B = new WeakMap, q = new WeakMap, W = new WeakMap, G = new WeakMap, J = new WeakMap, H = new WeakMap, be = function () { function i(e, t, n) { var a = this; x(this, i), B.set(this, { writable: !0, value: void 0 }), q.set(this, { writable: !0, value: void 0 }), W.set(this, { writable: !0, value: void 0 }), G.set(this, { writable: !0, value: void 0 }), J.set(this, { writable: !0, value: void 0 }), H.set(this, { writable: !0, value: void 0 }), P(this, G, e), P(this, J, t), P(this, H, n), P(this, B, []), P(this, W, {}), P(this, q, {}), t.forEach(function (e) { j(a, B).push(e.key), j(a, W)[e.key] = new L(a, e.key), j(a, q)[e.key] = e }), this.field = this.field.bind(this), this.component = this.component.bind(this), this.hasField = this.hasField.bind(this), this.getField = this.getField.bind(this), this.setFieldValue = this.setFieldValue.bind(this), this.getFieldValue = this.getFieldValue.bind(this), this.fieldNamesByTag = this.fieldNamesByTag.bind(this), this.autoCreateAbsentFields = this.autoCreateAbsentFields.bind(this) } return V(i, [{ key: "fieldNamesByTag", value: function (t) { return t && "" !== t ? j(this, J).filter(function (e) { return e.tags && -1 < e.tags.indexOf(t) }).map(function (e) { return e.key }) : [] } }, { key: "field", value: function (e) { if (!j(this, B).includes(e)) throw new Error("Unknown field key ".concat(e)); return j(this, W)[e] } }, { key: "component", value: function (e) { if (!j(this, B).includes(e)) throw new Error("Unknown component key ".concat(e)); return j(this, q)[e] } }, { key: "hasField", value: function (e) { return !!this.fieldMap[e] } }, { key: "getField", value: function (e, t) { return this.field(e).getDOMField(t) } }, { key: "setFieldValue", value: function (e, t) { return this.field(e).setDOMFieldValue(t) } }, { key: "getFieldValue", value: function (e, t) { function n() { return a.getDOMFieldValue(t) } var a = this.field(e); return (this.options.getFieldValue || n)(e, n) } }, { key: "autoCreateAbsentFields", value: function () { var t = this; this.fieldNames.forEach(function (e) { return t.field(e).createFieldIfAbsent() }) } }, { key: "container", get: function () { return j(this, G) } }, { key: "options", get: function () { return j(this, H) } }, { key: "fieldNames", get: function () { return j(this, B) } }, { key: "fieldMap", get: function () { return j(this, q) } }]), i }(), z = function () { function e() { x(this, e) } return V(e, [{ key: "isDefinedAt", value: function () { } }, { key: "launch", value: function () { } }]), e }(), Y = function () { i(o, z); var e = D(o); function o() { return x(this, o), e.call(this) } return V(o, [{ key: "isDefinedAt", value: function (e) { return (e.host.includes("iqos-ecom.de02.agima.ru") || e.host.includes("iqos.ru")) && ("/loyalty-recommendations/" === e.path || "/dtereferralcode/" === e.path) } }, { key: "launch", value: function () { var n = oe(".personal-code__item form"); n.removeAttr("action").removeAttr("method"); var a = n.find(".personal-code__field-input"); function i(e) { var t = a.parent(); return t.addClass("is-bounce"), setTimeout(function () { t.removeClass("is-bounce") }, 1e3), n.find(".error-message").html('<div id="phone-error" class="is-error">' + e + "</div>") } function t() { var e = a.val(); if (!e || "" === e) return i("поле необходимо заполнить"); var t = e.replace(/[^0-9]/g, "").replace(/^(7|8)/g, ""); if (10 !== t.length) return i("Введите телефон в формате +7 (9XX) 123-45-67"); oe(".js-loader").show(), oe.get(oe.ube.host + "/api/referral/code/send?phone=" + t).done(function (e) { e && !0 === e.result ? (o.showCode(), window.digitalData.events.push({ category: "Lead", name: "Get Code Form Sent", label: "sms" })) : e && e.error && "" !== e.error ? o.showError(e.error) : o.showAbsent() }).always(function () { return oe(".js-loader").hide() }) } oe(".personal-code__popup .js-popup-close").off("click").click(function () { oe(this).parents(".personal-code__popup").first().addClass("is-hide"), oe("html, body").removeClass("is-overflow-hidden"), /iPad|iPhone|iPod/.test(window.navigator.userAgent) && (oe(window).scrollTop(oe(".js-personal-code").offset().top), oe("html, body").removeClass("is-mobile-overflow")) }), a.on("focus", function () { oe(this).val() && "" !== oe(this).val() || oe(this).val("+7 (") }), n.off("submit").submit(function (e) { return e.preventDefault(), t(), !1 }), n.find("button").off("click").click(function (e) { return e.preventDefault(), t(), !1 }) } }], [{ key: "showCode", value: function () { oe("#personal-code .personal-code__popup.js-popup-ok").removeClass("is-hide"), oe("html, body").addClass("is-no-scroll") } }, { key: "onPopupShow", value: function () { oe("html, body").addClass("is-overflow-hidden"), /iPad|iPhone|iPod/.test(window.navigator.userAgent) && oe("html, body").addClass("is-mobile-overflow") } }, { key: "showAbsent", value: function () { var e = oe("#personal-code .personal-code__popup.js-popup-alert"); e.find(".personal-code__popup-text").html('Данный номер телефона отсутствует в базе данных потребителей IQOS. Станьте участником <a style="text-align:center;color:#ffffff;" href="/about-iqos-club/">IQOS Club</a>, чтобы получить свой код рекомендаций.'), e.removeClass("is-hide"), o.onPopupShow() } }, { key: "showError", value: function (e) { var t = oe("#personal-code .personal-code__popup.js-popup-alert"); t.find(".personal-code__popup-text").html(e), t.removeClass("is-hide"), o.onPopupShow() } }]), o }(), Q = function () { i(n, z); var t = D(n); function n() { var e; return x(this, n), (e = t.call(this)).launch = e.launch.bind(I(e)), e.display = e.display.bind(I(e)), e.showAll = !1, e.limit = 5, e } return V(n, [{ key: "isDefinedAt", value: function () { return !1 } }, { key: "launch", value: function () { var t = this; this.template ? this.display() : oe.get(oe.ube.host + "/template/loyalty-history").done(function (e) { t.template = e, t.display() }) } }, { key: "display", value: function () { var t = this; oe(".loyalty-history").remove(); var e = oe(this.template), i = e.find(".loyalty-history_holder"), o = e.find(".loyalty-history_entry").clone(); i.empty(); function n(e) { var t = o.clone(), n = parseInt(e.points) || 0, a = "Баллов"; n % 10 == 1 ? a = "Балл" : n % 10 < 5 && 1 < n % 10 && (a = "Балла"), e.deactivated && e.deactivatedText ? (t.find(".loyalty-history_label").text("У вас списаны баллы"), t.find(".loyalty-history_date").text(e.deactivated), t.find(".loyalty-history_description").text(e.deactivatedText), t.find(".loyalty-history_points").text("- " + n + " " + a)) : (t.find(".loyalty-history_label").text("Вам начислены баллы"), t.find(".loyalty-history_date").text(e.created), t.find(".loyalty-history_description").text(e.text), t.find(".loyalty-history_points").text("+ " + n + " " + a)), i.append(t) } var a = [{ created: "21 сентября", text: "Покупка устройства или аксессуаров IQOS", points: 500 }, { created: "20 сентября", text: "Покупка другом по вашему коду рекомендаций", points: 304 }, { created: "19 сентября", text: "Заполнение профиля", points: 101 }, { deactivated: "18 сентября", deactivatedText: "Удаление ранее заполненной информации в профиле", points: 500 }, { deactivated: "17 сентября", deactivatedText: "Удаление аккаунта социальной сети в личном профиле", points: 491 }, { created: "15 сентября", text: "Покупка устройства или аксессуаров IQOS", points: 354 }, { created: "10 сентября", text: "Покупка другом по вашему коду рекомендаций", points: 100 }, { created: "9 сентября", text: "Заполнение профиля", points: 105 }], r = e.find(".loyalty-history_button a"); r.click(function (e) { return e.preventDefault(), r.hide(), a.slice(t.limit).forEach(n), !1 }), 0 < a.length && (a.slice(0, this.limit).forEach(n), a.length > this.limit ? r.show() : r.hide(), oe(".points-progress").after(e)) } }], [{ key: "showCode", value: function () { oe("#personal-code .personal-code__popup.js-popup-ok").removeClass("is-hide") } }, { key: "showAbsent", value: function () { var e = oe("#personal-code .personal-code__popup.js-popup-alert"); e.find(".personal-code__popup-text").html('Данный номер телефона отсутствует в базе данных потребителей IQOS. Станьте участником <a style="text-align:center;display:block;color:#ffffff;" href="/about-iqos-club/">IQOS Club,<br/> чтобы получить свой код рекомендаций.</a>'), e.removeClass("is-hide") } }, { key: "showError", value: function (e) { var t = oe("#personal-code .personal-code__popup.js-popup-alert"); t.find(".personal-code__popup-text").html(e), t.removeClass("is-hide") } }]), n }(), X = [new Y, new Q], Z = function () { function i(e, t, n, a) { x(this, i), this.key = e, this.value = t, this.isValid = n, this.path = a } return V(i, [{ key: "json", get: function () { return { key: this.key, value: this.value, isValid: this.isValid, path: this.path } } }]), i }(), ve = function () { function e() { x(this, e), this.validations = [] } return V(e, [{ key: "addValidationResult", value: function (e, t, n, a) { a && a.includes("?") && (a = a.split("?")[0]), this.validations.push(new Z(e, t, n, a)) } }, { key: "json", get: function () { return { validations: this.validations.filter(function (e) { return ["/validate/email", "/validate/phone"].includes(e.path) }).map(function (e) { return e.json }) } } }]), e }(), ge = function () { function e() { x(this, e), this.fields = {}, this.start = (new Date).getTime(), this.end = void 0, this.focus = this.focus.bind(this), this.blur = this.blur.bind(this), this.ends = this.ends.bind(this) } return V(e, [{ key: "focus", value: function (e) { e && (this.fields[e] || (this.fields[e] = {}), this.fields[e].start = (new Date).getTime() - this.start) } }, { key: "blur", value: function (e) { e && (this.fields[e] || (this.fields[e] = {}), this.fields[e].end = (new Date).getTime() - this.start) } }, { key: "ends", value: function () { return this.end = (new Date).getTime() - this.start, { start: this.start, end: this.end, fields: this.fields } } }]), e }(), ye = []; function we(e, t, n) { var a, i, o, r, s, u = Object.assign({}, t); a = e, s = function (e) { e && (u.grecaptcha = e), n(u) }, window.ubeCaptchaCallback = s, window.ubeGlobalCaptchaCallback || (window.ubeGlobalCaptchaCallback = function (e) { window.ubeCaptchaCallback && window.ubeCaptchaCallback(e) }), i = window.ubeGlobalCaptchaCallback, (r = a.attr("withReCaptcha")) ? (null == (o = a.data("recaptchaWidgetId")) || null == o ? (o = grecaptcha.render(r, { callback: i }), a.data("recaptchaWidgetId", o)) : grecaptcha.reset(o), grecaptcha.execute(o)) : i() } function ee(e) { $.ube.toggleLoader && $.ube.toggleLoader(e) } function ke(e, a, t, i) { var o = { sessionKey: e, termsCodesAndVersions: t }; return new Promise(function (t, n) { $.ajax({ url: i + "/session/" + a + "/acceptTerms", data: JSON.stringify(o), type: "POST", processData: !1, cache: !1, dataType: "json", contentType: "application/json", crossDomain: !0, error: function (e) { return ee(!1), n(e) }, success: function (e) { return ee(!1), t(e) } }) }) } function Ce(e, a, t, i) { var o = { sessionKey: e, newPassword: t }; return new Promise(function (t, n) { $.ajax({ url: i + "/session/" + a + "/setPassword", data: JSON.stringify(o), type: "POST", processData: !1, cache: !1, dataType: "json", contentType: "application/json", crossDomain: !0, error: function (e) { return ee(!1), n(e) }, success: function (e) { return ee(!1), t(e) } }) }) } function Se() { } function Ae(e) { return ("" + e).charAt(0).toUpperCase() + e.slice(1) } function Te(e, t) { if (sessionStorage) return e && void 0 === t ? sessionStorage.getItem(e) : e && null === t ? sessionStorage.removeItem(e) : e ? sessionStorage.setItem(e, t) : void 0 } function xe(n, a, i) { var e = i.kind, t = i.label, o = i.requireConsent, r = void 0 !== o && o, s = i.entity, u = i.termsCode, l = void 0 === u ? [] : u, c = i.enterPassword, d = void 0 !== c && c, f = i.userId, h = oe.ube.host + "/api"; if (oe.ube && oe.ube.login) { if (de("Login", "Success", t || e), d && "function" == typeof oe.ube.enterPassword) return oe.ube.enterPassword(n, function (e) { return Ce(n, s, e, h) }, f).then(function (e) { var t = pe(pe({}, i), {}, { enterPassword: !1 }); return xe(n, a, t) }).catch(function (e) { }); if (d && "function" != typeof oe.ube.enterPassword) { var p = pe(pe({}, i), {}, { enterPassword: !1 }); return xe(n, a, p) } return r && "function" == typeof oe.ube.showTermsPopup ? oe.ube.showTermsPopup(n, l, function () { return ke(n, s, l, h) }, f).then(function (e) { var t = pe(pe({}, i), {}, { requireConsent: !1 }); return xe(n, a, t) }).catch(function (e) { }) : oe.ube.login(n, a, e) } } function Ve(e, t) { e && e.sessionKey ? (de("Social-Login", "Success", e.socialKey), xe(e.sessionKey, e.redirectUrl, { kind: e.kind, socialKey: e.socialKey, requireConsent: e.data.requireConsent, entity: t, termsCode: e.data.termsCode })) : (e.socialId && (de("Social-Login", "Data-Received", e.socialKey), ae(e.socialId, e.socialKey, e.data)), e.registrationUrl ? (de("Social-Login", "Redirect-Registration", e.socialKey), window.location.href = e.registrationUrl) : e.message && (de("Social-Login", "Popup-Message", e.socialKey), oe.ube.showPopup(e.message), oe.ube && oe.ube.loginFail && oe.ube.loginFail())) } function Ee(n, a, i, o, r, s) { var u = window.location.protocol + "//" + window.location.hostname; window.location.port && "" !== window.location.port && (u = u + ":" + window.location.port); var e = u += "/", t = "location=0,status=0,width=" + Math.min(Math.max(oe(window).width() - 300, 800), 1200) + ",height=650", l = window.open(e, "PMSM авторизация " + n, t); oe.get(o + "/auth/" + i + "/" + n + "/url", { sessionKey: a, popup: u }).done(function (e) { l.location.href = e.authorizationUrl; var t = window.setInterval(function () { var e; l.closed && window.clearInterval(t), -1 < l.location.href.indexOf("code=") && (window.clearInterval(t), s ? l.location.href = s : l.close(), (e = l.location.href.split("code=")[1].split("&")[0]) && "" !== e && oe.get(o + "/auth/" + i + "/" + n + "/callback", { code: e, sessionKey: a, popup: u }).done(function (e) { var t; e.data && (t = "vk" === n ? e.data.user_id : "instagram" === n ? e.data.instagram : e.data.user_id || e.data.userId || e.data.socialId || e.data.id, r(t, e)) }).fail(function () { })) }, 300) }) } function Oe() { Fe.forEach(function (e) { Te(e, null) }) } var te = t, ne = n, Fe = ["socialId", "socialKey", "email", "firstName", "lastName", "phone", "gender", "birthDate", "instagram", "vkontakte", "facebook", "telegram", "viber", "utmCampaign", "utmContent", "utmSource", "utmMedia"], ae = function (e, t, n) { Fe.forEach(function (e) { n[e] && Te(e, n[e]) }), Te("socialId", e), Te("socialKey", t) }; function Ie() { var e = location.search.substr(1), n = {}; return e.split("&").forEach(function (e) { var t = e.split("="); n[t[0]] = decodeURIComponent(t[1]) }), n } oe.ubeLoginTelegram = function (e, t) { oe.get(oe.ube.host + "/api/auth/" + e + "/telegram/callback", t).done(function (e) { ee(!1), e && e.sessionKey ? xe(e.sessionKey, e.redirectUrl, { kind: "telegram" }) : (e.socialId && ae(t.id, "telegram", e.data), e.registrationUrl ? window.location.href = e.registrationUrl : e.message && oe.ube.showPopup(e.message)) }).fail(function () { ee(!1) }) }, window.ubeLoginTelegram = oe.ubeLoginTelegram, oe.fn.ubeCabinet = function (i, e, o) { var t = oe(this), r = e; var n = i.replace(/\/main\/(.[^/]+)-cabinet/, "/esb/$1-cabinet/cabinet"); o && o.data && o.data.userId && (n = n + "?userId=" + o.data.userId); function a() { ee(!0) } var s = o.template || i.replace("/main/", "/template/"); ee(!0); function u() { var a; l && c && d && (ee(!1), a = t, function (e, t) { var n = o || {}; n.data = oe.extend({}, e, (o || {}).data || {}), n.sessionKey = r, n.loadFormDataFromSession = !1, n.formDefinitionJson = t, n.isTemplatePreloaded = !0, e.error ? n.onSessionError && n.onSessionError(e.error, r) : a.ube(i, n) }(l, c)) } var l, c = !1, d = o && o.isTemplatePreloaded, f = oe.getJSON(i).fail(Se).fail(a); oe.ajax({ url: n, headers: { "ube-session-key": r }, success: function (e, t, n) { l = e; var a = n.getResponseHeader("UBE_SESSION_KEY") || n.getResponseHeader("ube-session-key"); a && "" !== a && (r = a), u() }, error: function (e, t, n) { ee(!1), oe.ube && oe.ube.showPopup("Ошибка загрузки данных в форму:" + n) } }).fail(Se).fail(a); f.done(function (e) { c = e, u() }), d || /(retail)/.test(s) && !t.is(":empty") ? (d = !0, u()) : oe.get(s).fail(Se).fail(a).done(function (e) { t.html(e), d = !0, u() }) }, oe.fn.ubeAV = function (e, t, n) { var a = oe(this), i = n || {}, o = e.replace(/.*\//, ""), r = e.replace(o, "av"); i.sessionKey = t, i.template = e.replace("/main/", "/template/").replace("-reg", "-av"), i.data || (i.data = {}), i.data.entity = o, a.ube(r, i) }, oe.fn.ubeNext = function () { oe(this).trigger("ubeNext") }, oe.fn.ubePrev = function () { oe(this).trigger("ubePrev") }, oe.fn.ube = function (Q, X) { var e, s = {}, Z = (X = X || {}).sessionKey; function n(e) { var t; e && e.data && e.data.form && (X.loadFormDataFromSession = !1, t = e.data, X.template = t.template || X.template, X.data = t.data || X.data, Q = t.form, Z = t.sessionKey) } !Z && ue(l) && Q && ("string" == typeof Q || Q instanceof String) && Q.endsWith("-reg") && (Z = ue(l)), n(Q = ("string" == typeof (e = Q) || e instanceof String) && e && !/^http(s)?:\/\//.test(e) && !/\//.test(e) && /-/.test(e) && e.length < 64 ? (v(), $.ube.host + "/main/" + e) : e); var ee = (location.search.substring(1) || "").split("&").reduce(function (e, t) { var n = t.split("="); return 1 === n.length && (e[decodeURIComponent(n[0])] = decodeURIComponent(n[0])), 1 < n.length && (e[decodeURIComponent(n[0])] = decodeURIComponent(n[1])), e }, {}), d = {}; for (var t in oe.ube) X[t] = oe.ube[t]; var te = oe(this).first(), ne = Q.replace(/^((http|https)?:\/\/[^\/]+)(\/.*)?$/, "$1"), ae = ne + "/api", a = ae + "/session/get?sessionKey=" + Z; X.data = X.data || {}; var ie = {}; function f(e, n) { var a = []; return e.forEach(function (t) { n && (!n.conditional || !n.conditional.when || t.conditional && t.conditional.when || (t.conditional = n.conditional), n.customConditional && 0 < n.customConditional.length && (!t.customConditional || 0 == t.customConditional.length) && (t.customConditional = n.customConditional)), a.push(t), t.components && (a = a.concat(f(t.components, t))), t.columns && t.columns.forEach(function (e) { e.components && (a = a.concat(f(e.components, t))) }) }), a } function i(x) { var V = x.path, E = "wizard" == x.display, O = x.properties || {}, e = f(x.components), F = new be(te, e, X), I = F.fieldMap, D = F.fieldNames, _ = F.hasField, j = F.getField, P = F.setFieldValue, M = F.fieldNamesByTag, R = function (e) { return F.getFieldValue(e, ie[e]) }, U = new ve; function K(t) { if (!t || "" == t) return D; var e = x.components.filter(function (e) { return "panel" == e.type }), n = []; return e.forEach(function (e) { e.key === t && f(e.components || [], e).forEach(function (e) { n.push(e.key) }) }), n } function N(e) { var t = I[e]; if (t) return f([t]).map(function (e) { return e.key }) } var t; !function (t, e) { e = e || null; location.search.substring(1); var n = Ie(); !n.hash && n.T && (n.hash = n.T); !n.hash && n.hid && (n.hash = n.hid); var a = n.redirectTo || n.redirect; n && n.hash && "" != n.hash ? (z(!0), v(), oe.get(oe.ube.host + "/api/session/resolveHash?hash=" + n.hash + "&entity=" + e).always(function () { z(!1) }).done(function (e) { a && "" != a || (a = e.redirectUrl), function (e) { if (!e || "" === e) return !0; var t = (window.location.hostname || "") + ""; if (!t) return !0; try { var n = new URL(e), a = (n.hostname || "") + ""; return a == t } catch (e) { } return !0 }(a) || (a = window.location.protocol + "//" + window.location.host), oe.ube.login && e && e.sessionKey ? xe(e.sessionKey, a, { kind: e.kind, requireConsent: e.requireConsent || !1, entity: t.path, termsCode: e.termsCode || [], enterPassword: e.enterPassword, userId: e.userId }) : oe.ube.loginFail && e && !e.sessionKey && oe.ube.loginFail(e) })) : n.socialKey && n.code ? (z(!0), v(), oe.get(oe.ube.host + "/api/auth/" + n.entity + "/" + n.socialKey + "/callback", { code: n.code, sessionKey: n.sessionKey }).done(function (e) { z(!1), Ve(e, n.entity) }).fail(function () { z(!1), oe.ube.loginFail && oe.ube.loginFail() })) : oe.ube && oe.ube.loginAbsent && oe.ube.loginAbsent() }(x, V); var i = ""; function o() { te.find("[name=gender]").hasClass("noAutolookup") || V.includes("-cabinet") || (t && clearTimeout(t), t = setTimeout(function () { var e, t, n, a = q() || {}; a.firstName && "" !== a.firstName && a.lastName && "" !== a.lastName && (e = a.firstName, t = a.lastName, n = function (e) { (i !== e && "male" === e || "female" === e) && P("gender", i = e) }, oe.ajax({ url: ae + "/lookup/gender?query=" + encodeURIComponent(e + " " + t), success: function (e) { n(e.result) } })) }, 300)) } function L(e) { te.find(".ube-validation-set-class-" + e).each(function () { oe(this).removeClass(oe(this).attr("data-ube-validation-success-class") || "ube-validation-success").removeClass(oe(this).attr("data-ube-validation-class") || "ube-validation-error") }), te.find(".ube-validation-message-for-" + e).empty(), te.find(".ube-validation-message-show-for-" + e).hide() } function l(e, t) { function n(e) { te.find("input[name='" + e + "']"), te.find(".ube-validation-set-class-" + e).each(function () { oe(this).addClass(oe(this).attr("data-ube-validation-success-class") || "ube-validation-success").removeClass(oe(this).attr("data-ube-validation-class") || "ube-validation-error") }), te.find(".ube-validation-message-for-" + e).html(""), te.find(".ube-validation-message-show-for-" + e).hide(), "firstName" != e && "lastName" != e || o() } var a, i = X.setFieldValid; !e || !t || "" == t || s[e] || (a = j(e)) && a.is(":visible") && (s[e] = !0), (i || n)(e, t, n) } function B(e, t, n) { function a(e, t, n) { te.find(".ube-validation-set-class-" + e).each(function () { oe(this).removeClass(oe(this).attr("data-ube-validation-success-class") || "ube-validation-success").addClass(oe(this).attr("data-ube-validation-class") || "ube-validation-error") }), te.find(".ube-validation-message-for-" + e).html(n), te.find(".ube-validation-message-show-for-" + e).show() } var i, o = X.setFieldInvalid; !e || !1 === s[e] || (i = j(e)) && i.is(":visible") && (s[e] = !1, de("Registration", "Invalid-" + e, n)), (o || a)(e, t, n, a) } function $(a, i, o, r) { var s = R(a); c(a, s, function (e, t) { l(e, t), i && i(e, t) }, function (e, t, n) { r || B(e, t, n), o && o(e, t, n) }, function (e, t, n) { l(a, s), i && i(a, s) }) } var m = {}; function c(o, r, a, i, e, t) { var s = I[o], n = s.validate; function u(e) { return s.tags && -1 < s.tags.indexOf(e) } function l(e, t, n) { c(e, function (e) { e ? (n || a)(o, r) : i(o, r, t) }) } function c(a, i) { oe.ajax({ url: ae + a, success: function (e) { var t = e.result, n = 1 == e.error || 0 <= [!0, "true", "unknown"].indexOf(t); U.addValidationResult(o, r, n, a), i(n, e.message) }, error: e }) } if (t = t || q(), !b(o, t || q())) return a(o, r); if (n) { var d = n.customMessage && "" != n.customMessage ? n.customMessage : "Пожалуйста, укажите " + s.label; if (n.required && 0 == (r || "").length) return i(o, r, d); if (n.pattern && 0 < n.pattern.length && !new RegExp(n.pattern).test(r)) return i(o, r, d); if (n.custom && 0 < n.custom.length) { var f = new Function("valid, input, query, data, initialData", n.custom + "; return valid;")(!0, r, ee, t || q(), pe({}, X.data)); if (1 != f && f && 0 < f.length) return i(o, r, f) } } function h(e, t) { t && 0 < t.length && X.validateValue ? X.validateValue(e, t, a, i) : a(e, t), t && "" !== t && u("submitOnValid") && m[e] !== t && te.find("form").submit(), m[e] = t } if (u("validateServerSide")) { var p = { firstName: t.firstName, userId: t.userId }; return p[o] = r, oe.ajax({ url: ne + "/esb/" + V + "/validate" + (Z ? "?sessionKey=" + Z : ""), method: "post", data: JSON.stringify(p), contentType: "application/json; charset=UTF-8", success: function (e) { e.sessionKey && (Z = e.sessionKey); var t = e && e.result && e.fields && e.fields[o] && e.fields[o].result; 1 == e.error || 0 <= [!0, "true", "unknown"].indexOf(t) ? h(o, r) : i(o, r, e && e.fields && e.fields[o] && e.fields[o].message ? e.fields[o].message : "Введите корректное значение") }, error: e }) } return "email" == s.type ? ("email" === o && _(o + "ValidatedValue") && R(o + "ValidatedValue") && R(o + "ValidatedValue") !== r && (P(o + "CodeSent", !1), P(o + "ValidatedValue", null), P("submitted" + Ae(o) + "Code", null), $("submitted" + Ae(o) + "Code"), W()), r && "" != r ? (l("/validate/email?email=" + r + "&optin=" + u("optin"), "Введите существующий E-Mail адрес", function () { var e = _("userId") ? R("userId") : null, t = e ? "&userId=" + e : "", n = s.uniqueError; u("validateNotExists") ? l("/validate/emailNotExists?email=" + r + t, n && "" !== n ? n : "E-Mail адрес уже был зарегистрирован ранее") : h(o, r) }), 0) : a(o, r)) : "phoneNumber" == s.type ? ("phone" === o && _(o + "ValidatedValue") && R(o + "ValidatedValue") && R(o + "ValidatedValue") !== r && (P(o + "CodeSent", !1), P(o + "ValidatedValue", null), P("submitted" + Ae(o) + "Code", null), $("submitted" + Ae(o) + "Code"), W()), l("/validate/phone?number=" + r, "Введите существующий номер телефона", function () { var e = _("userId") ? R("userId") : null, t = e ? "&userId=" + e : "", n = s.uniqueError; u("validateNotExists") ? l("/validate/phoneNotExists?number=" + r + t, n && "" !== n ? n : "Телефон уже был зарегистрирован ранее") : h(o, r) }), 0) : r && 0 < r.length && "voucher" == o ? (c("/validate/voucher?voucher=" + r + "&entity=" + V, function (e, t) { e ? a(o, r) : X.validateValue ? X.validateValue(o, r, a, i) : i(o, r, t || "Введите существующий код ваучера") }), 0) : r && 0 < r.length && u("validateBonusCard") ? (c("/validate/bonusCard?value=" + r + "&entity=" + V, function (e, t) { e ? a(o, r) : i(o, r, t) }), 0) : void h(o, r) } function u(e) { return j(e).data("data-object") || R(e) } function q(e) { var i = {}; return K(e).forEach(function (e) { i[e] = R(e), !i[e] && Te(e) && (i[e] = Te(e)) }), K(e).forEach(function (e) { var t, n, a = I[e].calculateValue; a && 0 < a.length && (t = { getFieldObject: u }, n = new Function("value, data, helper, query, initialData", a + "; return value;")(i[e], i, t, ee, pe({}, X.data)), i[e] = n) }), i } function b(e, t) { return G(e, function (e, t) { var n = I[e], a = n.conditional, i = n.customConditional, o = !0, r = !0; { a && a.show && 0 < a.show.length && a.when && 0 < a.when.length && a.eq && 0 < a.eq.length && (s = "true" == a.show || 1 == a.show, o = (t[a.when] || "").toString() == a.eq.toString() ? s : !s) } { var s; i && 0 < i.length && (s = new Function("show, data, helper, query, initialData", i + "; return show;")(!0, t, { getFieldObject: u }, ee, pe({}, X.data)), r = !(0 == s || "false" == s)) } return o && r }(e, t)) } function W(t) { var n = q(); D.forEach(function (e) { e != t && b(e, n) }) } function G(e, t) { var n, a = te.find(".ube-visibility-show-for-" + e), i = te.find(".ube-visibility-hide-for-" + e), o = I[e]; return t || (n = a.is(":visible")) && o.tags && 0 <= o.tags.indexOf("getFRToken") && (d.getFRToken = !1, te.find("form").trigger("stopVideoCapture").off("stopVideoCapture"), oe(".ube-face-error").hide(), oe(".ube-face-container").show()), t ? (n = a.is(":visible"), a.attr("data-ube-display") ? a.css("display", a.attr("data-ube-display")) : a.show(), i.hide(), !n && !d.sendMegafonCode && o.tags && 0 <= o.tags.indexOf("sendMegafonCode") && (de("AV", "Initialize", "megafon"), z(d.sendMegafonCode = !0), setTimeout(function () { te.find("form").trigger("submitNoValidation") }, 100)), (!n || !d.getFRToken) && o.tags && 0 <= o.tags.indexOf("getFRToken") && (de("AV", "Initialize", "face"), z(d.getFRToken = !0), P("token", null), P("tokenUrl", null), setTimeout(function () { te.find("form").trigger("submitNoValidation") }, 100))) : (a.hide(), i.attr("data-ube-display") ? i.css("display", i.attr("data-ube-display")) : i.show()), t } function J(e, t, n) { e = e || function () { }, t = t || function () { }; var o = {}, r = {}, a = n.length; function s() { return !(Object.keys(o).length < a) && (0 == Object.keys(r).length ? e() : t(r)) } var u = q(); n.forEach(function (a) { var i = R(a); b(a, u); c(a, i, function (e, t) { o[e] = "valid", l(e, t), s() }, function (e, t, n) { o[e] = "invalid", B(e, t, r[e] = n), s() }, function (e, t, n) { o[a] = "error", l(a, i), s() }, u) }) } var H = !1; function z(e) { H = e, X.toggleLoader && X.toggleLoader(e) } function Y(e) { X.showPopup ? X.showPopup(e) : alert(e) } function n() { var n, l, c = te.find("form"), d = x.path; F.autoCreateAbsentFields(); var a, i, e, t, o, r, u, s, f, h, p, m = new ge; function b(s, e) { var u, t = n; (Z || X.sessionKey) && (t += "?sessionKey=" + (Z || X.sessionKey)), c.attr("action", ne + t), "AV" === l ? u = s.data.method : "Login" === l ? u = "password" : "Registration" === l && (u = s.data.utmSource), function (t) { try { if (!t) return; var n = {}; he.forEach(function (e) { t[e] && (n["v" + e] = t[e]) }), 0 < Object.keys(n).length && dataLayer.push(n) } catch (e) { } }(s.data), s.isSearchOnly = e, oe.ajax({ type: "POST", url: c.attr("action"), data: JSON.stringify(s), contentType: "application/json; charset=UTF-8", success: function () { z(!1) }, error: function () { de(l, "Error", u), z(!1) } }).done(function (e) { function r(t) { return t.data && (t.data.userId ? fe(t.data.userId) : t.data.data && t.data.data.userId && fe(t.data.data.userId)), t.sessionKey && (Z = t.sessionKey), t.data && t.data.requireConsent && "function" == typeof oe.ube.showTermsPopup ? oe.ube.showTermsPopup(t.data.sessionKey, t.data.termsCode, function () { return ke(t.data.sessionKey, d, t.data.termsCode, ae) }, t.data.userId).then(function (e) { return r(pe(pe({}, t), {}, { data: pe(pe({}, t.data), {}, { requireConsent: !1 }) })) }).catch(function (e) { }) : "enterPassword" == t.event && "function" == typeof oe.ube.enterPassword ? oe.ube.enterPassword(t.data.sessionKey, function (e) { return Ce(t.data.sessionKey, d, e, ae) }, t.data.userId).then(function (e) { return r(pe(pe({}, t), {}, { event: "loginSuccess" })) }).catch(function (e) { }) : "enterPassword" == t.event && "function" != typeof oe.ube.enterPassword ? r(pe(pe({}, t), {}, { event: "loginSuccess" })) : ("ValidationError" === t.name ? (de(l, "ValidationError", u), a = {}, t.details.forEach(function (e) { var t = e.path, n = e.message; B(t, null, a[t] = n) }), X && X.onValidationFailure && X.onValidationFailure(a)) : t.error && 0 < t.error.length ? (de(l, "Error", u), Y(t.error)) : "update" == t.event ? y(t.data) : "face" == t.event ? (y(t.data), function () { var n = R("token"), a = R("tokenUrl"), e = te.find(".ube-camera-container"), i = te.find(".ube-camera-render"), s = te.find(".ube-camera-capture"), u = te.find(".ube-camera-fallback"); if (i.data("init") || !n || !a) return; function l(e, t) { de("AV", "AV-FR-Submit", "Submit-Photo"), z(!0), oe.ajax({ url: a, data: e, type: "POST", processData: !1, cache: !1, dataType: "json", contentType: "application/octet-stream", crossDomain: !0, headers: { Authorization: "Bearer " + n, "X-ACS-PICTURE-MODE": "stream" }, error: function () { z(!1), de("AV", "AV-FR-Failed", "Submit-Photo-Failed-Technical") }, success: function (e) { z(!1), e && ("SUCCESS" === e.status_code ? (c.trigger("submitNoValidation"), t && t()) : "DOCUMENT" === e.next_validation_type ? (de("AV", "AV-FR-Failed", "Submit-Photo-Failed-Second"), de("AV", "AV-FR-Failed-Details", e.error_message), 0 < oe(".ube-face-error").length ? (oe(".ube-face-container").hide(), oe(".ube-face-error").fadeIn(200), t && t()) : 0 < oe(".ube-visibility-show-for-documentMethod").length && 0 === oe(".ube-visibility-show-for-megafonMethod").length ? (Y("Ой! Похоже, что вы выглядите слишком молодо. Попробуйте подтвердить возраст с помощью документов"), setTimeout(function () { P("method", "document"), W(), t && t() }, 4e3)) : (Y("Ой! Похоже, что вы выглядите слишком молодо. Попробуйте подтвердить возраст через SMS код"), setTimeout(function () { P("method", "megafon"), W(), t && t() }, 4e3))) : e.error_message && (de("AV", "AV-FR-Failed", "Submit-Photo-Failed-First"), de("AV", "AV-FR-Failed-Details", e.error_message), Y("Ой! Похоже, что вы выглядите слишком молодо.<br><br> <small>Возможно вы не выполнили одно из условий. В любом случае стоит попробовать еще раз, чтобы изображение получилось более чётким, не засвеченным и не слишком затемненным.</small>"))) } }) } function t() { de("AV", "AV-FR-Mode", "AV-Upload"), e.removeClass("ube-camera-option-capture").addClass("ube-camera-option-upload"), u.show(), i.hide(); var n = oe('<input type="file" accept="image/*" capture="user" style=\'width:0;height:0;position:absolute;\'/>').appendTo("body"), t = ["image/jpeg", "image/jpg", "images/png", "images/gif"]; n.change(function () { if (0 !== this.files.length) { if (!(-1 < t.indexOf(this.files[0].type))) return void Y("Поддерживаются только форматы файлов изображений"); var e = new FileReader; e.addEventListener("load", function () { var e = this.result, t = w(e); n.val(""), n.wrap("<form>").closest("form").get(0).reset(), n.unwrap(), l(t) }, !1), e.readAsDataURL(this.files[0]) } }), s.add(".ube-camera-option-upload").off("click").click(function (e) { return e.preventDefault(), n.click(), !1 }) } i.data("init", !0), function () { if (se) return t(); u.hide(), i.html("<video></video>").show(), e.addClass("ube-camera-option-capture").removeClass("ube-camera-option-upload"); var o, r = i.find("video")[0]; navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? (r.setAttribute("autoplay", ""), r.setAttribute("muted", ""), r.setAttribute("playsinline", ""), o = function () { r.pause(), r.src = "", r.srcObject && r.srcObject.getTracks().forEach(function (e) { return e.stop() }), i.html(""), i.data("init", !1) }, c.on("stopVideoCapture", function () { o() }), navigator.mediaDevices.getUserMedia({ audio: !1, video: { facingMode: "user" } }).then(function (e) { r.srcObject = e, de("AV", "AV-FR-Mode", "AV-Stream"), s.off("click").click(function (e) { e.preventDefault(); var t = oe("<canvas style='visibility:hidden;display:block;position: absolute;top:-2000px;left:-2000px'></canvas>").appendTo("body")[0]; t.width = r.videoWidth, t.height = r.videoHeight, t.getContext("2d").drawImage(r, 0, 0); var n = t.toDataURL("image/png"), a = w(n), i = oe('<form style=\'position: absolute;top:-2000px;left:-2000px;display: block;\'><input type="text" id="filename" name="filename" /></form>'); return i.appendTo("body"), new FormData(i[0]).append("image", a), l(a, o), !1 }) }).catch(function (e) { t() })) : t() }() }()) : "beforeSubmit" == t.event ? (e = function () { return b(s, !1) }, X.onBeforeSubmit ? X.onBeforeSubmit(s, t.data, e, B) : e()) : "requireConsent" == t.event ? (de("Consent", "Show"), n = t.data.template, (i = oe(n)).appendTo("body"), i.find(".ube-form-submit-click").click(function (e) { return de("Consent", "Agree"), e.preventDefault(), i.trigger("remove").remove(), s.agreeWithNewConsents = !0, we(te, s, b), !1 }), i.find(".ube-trigger-event[data-ube-event=close]").click(function (e) { return de("Consent", "Close"), e.preventDefault(), i.trigger("remove").remove(), !1 })) : X.onSubmissionSuccess && function (e) { Oe(), de(l, "Success", u), e.event && de(l, "Result-Event-" + e.event, u); var t = e.data.submissionId, n = e.data.userId; e && e.data && e.data.data && (t = t || e.data.data.submissionId, n = n || e.data.data.userId); X.onSubmissionSuccess(t, n, e), te.add(c).trigger("formSuccess", s, e) }(t), void (t && t.ga && (t.ga instanceof Array ? t.ga.forEach(function (e) { de(e.category, e.action, e.label) }) : t.ga.action && de((o = t.ga).category, o.action, o.label)))); var a, e, n, i, o } Array.isArray(e) ? e.forEach(function (e) { r(e) }) : r(e) }) } function v(e) { return z(!0), e && (e.timer = m.ends(), e.context = U.json), b(e, !!X.onBeforeSubmit) } function g(e) { var t, n; H || (z(!0), t = { data: q(e) }, "AV" === l ? n = t.data.method : "Login" === l ? n = "password" : "Registration" === l && (n = t.data.utmSource), e && (t.part = e), J(function () { X.onValidationSuccess && X.onValidationSuccess(t), de(l, "Submit", n), z(!1), we(te, t, v) }, function (e) { X.onValidationFailure && X.onValidationFailure(e), z(!1); var t = Object.keys(e).map(function (e) { return j(e) }); oe.scrollToElement(oe(t).map(function () { return this.toArray() })) }, K(e))) } function y(t, e) { e = t.part; t.data && (t = t.data), X.data = t, K(e).forEach(function (e) { P(e, t[e]), j(e).blur() }) } function w(e) { var t = e.split(";"), n = t[0].split(":")[1]; return function (e, t, n) { t = t || "", n = n || 512; for (var a = atob(e), i = [], o = 0; o < a.length; o += n) { for (var r = a.slice(o, o + n), s = new Array(r.length), u = 0; u < r.length; u++)s[u] = r.charCodeAt(u); var l = new Uint8Array(s); i.push(l) } return new Blob(i, { type: t }) }(t[1].split(",")[1], n) } function k() { var e = oe(this).data("data-object"), t = oe(this).val(); (!e && t && "" !== t || e && e.label !== t) && (t && oe(this).data("source") && oe(this).data("source").find(function (e) { return e && e.label === t }) ? oe(this).data("ui-autocomplete")._trigger("select", "autocompleteselect", { item: oe(this).data("source").find(function (e) { return e && e.label === t }) }) : oe(this).attr("data-value", null).data("data-object", null).val(null).trigger("blur")) } function C(e, t) { oe(this).attr("data-value", t.item.value), oe(this).data("data-object", t.item), this.value = t.item.label, e.preventDefault() } function S(n) { return function () { var t = oe(this), e = t.attr("data-value"); e && "" != e && oe.ajax({ url: ae + "/lookup/brands/" + e, success: function (e) { e.result && e.result.value && e.result.label && (c.find(".ube-label-" + n).html(e.result.label), t.attr("data-value", e.result.value).data("data-object", e.result).val(e.result.label).trigger("blur")) } }) } } function A(n, a, i, e) { a = a || ""; var t = c.find("input[name='" + n + "'], .formio-lookup-" + n).ubeAutocomplete({ position: { my: "left top", at: "left bottom", collision: "none" }, classes: { "ui-autocomplete": "max-height" }, source: function (e, t) { oe.ajax({ url: ae + "/lookup/brands", data: { query: e.term, pmi: a, families: i }, success: function (e) { t(e.result) } }) }, minLength: 0, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.value), c.find(".ube-label-" + n).html(t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur") }, focus: C, change: k }).each(S(n)); e && t.focus(function () { 0 == t[Object.keys(t)[0]].value.length && oe(this).autocomplete("search", "") }) } function T() { window.grecaptcha || oe.getScript("https://www.google.com/recaptcha/api.js?render=explicit"); var e = "ube-" + Math.random().toString(36).substr(2); te.attr("withReCaptcha", e), te.find(".g-recaptcha").first().attr("id", e) } /-reg$/.test(d) ? (n = "/esb/" + d + "/submission", de("Registration", "Start"), l = "Registration") : /optin$/.test(d) ? (n = "/esb/" + d + "/submitCodes", de("2OPTIN", "Start"), l = "2OPTIN") : /av$/.test(d) ? (n = "/esb/" + d + "/submission", de("AV", "Start"), l = "AV") : /login$/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "Login", "Start")) : /remind/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "LoginRemind", "Start")) : /cabinet/.test(d) ? (n = "/esb/" + d + "/cabinet", de(l = "PersonalCabinet", "Start")) : /instagram/.test(d) ? (n = "/esb/" + d + "/instagram", de(l = "UpdateInstagram", "Start")) : /-vk$/.test(d) ? (n = "/esb/" + d + "/vk", de(l = "UpdateVK", "Start")) : /-phone$/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "PhoneVerification", "Start")) : /-phone-check$/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "PhoneVerification", "Sms")) : /-phone-send$/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "PhoneVerification", "Start")) : /-idx$/.test(d) ? (n = "/esb/" + d + "/submission", de(l = "IDXVerification", "Start")) : (n = "/main/" + d + "/submission", de(d, "Start"), l = d), c.on("submitNoValidation", function (e) { e.preventDefault(), z(!0), v({ data: q() }) }), c.submit(function (e) { return e.preventDefault(), g(), !1 }), c.find(".ube-form-submit-click").click(function (e) { return e.preventDefault(), g(oe(this).attr("data-part")), !1 }), c.find("[type=submit]").click(function (e) { return e.preventDefault(), g(oe(this).filter("[name=part]").val()), !1 }), te.find(".ube-camera-container").click(function (e) { if (_("method") && _("token") && "face" === R("method")) { var t = R("token"); if (!t || "" === t) return e.preventDefault(), c.trigger("submitNoValidation"), !1 } }), D.forEach(function (t) { var i = c.find("[name='" + t + "']"), e = I[t], o = e.type, n = X.data[t] || i.attr("data-ube-initial"); "ageVerifiedToken" !== t || n && "" !== n || !ue(le) || (n = ue(le)), "ageVerified" !== t || n && "" !== n || !ue(ce) || (n = ue(ce)), /-reg$/.test(d) && -1 < Fe.indexOf(t) && Te(t) && (n && "" !== n || (n = Te(t))), e.defaultValue && 0 < e.defaultValue.length && (n = e.defaultValue), e.customDefaultValue && 0 < e.customDefaultValue.length && (n = new Function("value, data, query", e.customDefaultValue + "; return value;")(n, X.data, ee)), !n && 0 == n || (P(t, n), ie[t] = n), oe(".ube-value-update-on-click-" + t).click(function () { P(t, oe(this).attr("data-option")), j(t).blur() }); function a(t, n) { var e, a; "checkbox" === o ? i.change(n) : "radio" === o ? i.blur(n).click(n) : "file" === o ? i.change(function (e) { return i.ubeFileToBase64({ callback: n, previewSelector: te.find(".ube-file-preview-".concat(t || "document")) }), e.preventDefault, !1 }) : "textfield" === o || "phoneNumber" === o || "email" === o || "number" === o ? (a = function () { e && clearTimeout(e), e = setTimeout(function () { n(!0) }, 650) }, re && i.on("keyup", a), i.on("paste", a).keypress(a).blur(function () { e && clearTimeout(e), e = null, n() })) : i.blur(n) } (X.bindValidation || a)(t, function (e) { W(t), $(t, null, null, e) }, a); var r = e.inputMask, s = e.placeholder, u = e.properties ? e.properties.inputPlaceholder : void 0; r && 0 < r.length && i.ubeMask(r, s, u), s && 0 < s.length && i.attr("placeholder", s), W(), i.focus(function () { m.focus(t) }), i.blur(function () { m.blur(t) }) }), te.find(".ube-mask").ubeMask(), c.find("input[name='firstName'], .formio-lookup-name").not("[autocomplete='off']").ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/fio", data: { query: e.term, part: "name" }, success: function (e) { t((e.result || []).slice(0, 5)) } }) } }), c.find("input[name='lastName'], .formio-lookup-lastname, .formio-lookup-surname").not("[autocomplete='off']").ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/fio", data: { query: e.term, part: "surname" }, success: function (e) { t((e.result || []).slice(0, 5)) } }) } }), te.find(".ube-lookup-cityTrial").ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/cityTrial", data: { query: e.term }, success: function (e) { t(e.result.slice(0, 10)) } }) }, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur") }, focus: C, change: k }).each(function () { var n = oe(this); oe.ajax({ url: ae + "/lookup/currentCityTrial", success: function (e) { var t; e.result && Array.isArray(e.result) && e.result[0] && (t = e.result[0], n.attr("data-value", t.value).data("data-object", t).val(t.label).trigger("blur")) }, error: function () { } }) }), te.find(".ube-lookup-metroTrial").each(function () { oe(this).ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/metroTrial", data: { metro: e.term, city: _("city") ? R("city") : null }, success: function (e) { t(e.result.slice(0, 10)) } }) }, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur") }, focus: C, change: k }) }), te.find(".formio-lookup-address").each(function () { var e = oe(this), i = oe(this).attr("data-address-prefix") || "shipping"; e.ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/address", data: { query: e.term, city: _("city") ? R("city") : null }, success: function (e) { t(e.result.slice(0, 5)) } }) }, select: function (e, t) { var n, a; e.preventDefault(), oe(this).attr("data-value", t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur"), t.item && t.item.data && ((n = t.item.data) && (a = { setAddress: t.item.label, setAddressCity: n.city, setAddressKladr: n.kladr_id, setAddressCityKladr: n.city_kladr_id, setAddressStreet: n.street, setAddressStreetType: n.street_type, setAddressHouse: n.house, setAddressBlock: n.block, setAddressFlat: n.flat, setPostalCode: n.postal_code }, Object.keys(a).forEach(function (t) { M(t).forEach(function (e) { -1 < e.indexOf(i) && _(e) && P(e, a[t]) }) }))) }, focus: C, change: k }); var t = oe(this).val(); t && "" != t && oe.ajax({ url: ae + "/lookup/address", data: { query: t, city: _("city") ? R("city") : null }, success: function (e) { var t, n; e && e.result && e.result[0] && e.result[0].data && (t = e.result[0].data, n = { setAddressCity: t.city, setAddressKladr: t.kladr_id, setAddressCityKladr: t.city_kladr_id, setAddressStreet: t.street, setAddressStreetType: t.street_type, setAddressHouse: t.house, setAddressBlock: t.block, setAddressFlat: t.flat, setPostalCode: t.postal_code }, Object.keys(n).forEach(function (t) { M(t).forEach(function (e) { n[t] && "" !== n[t] && -1 < e.indexOf(i) && _(e) && P(e, n[t]) }) })) } }) }), te.find("input[name='locationId'], .formio-lookup-location").ubeAutocomplete({ source: function (e, t) { oe.ajax({ url: ae + "/lookup/cities", data: { query: e.term }, success: function (e) { t(e.result.slice(0, 5)) } }) }, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.value), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur") }, focus: C, change: k }).each(function () { var t = oe(this), e = t.attr("data-value"), n = { value: 77e9, label: "г. Москва" }; function a(e) { t.attr("data-value", e.value).data("data-object", e).val(e.label).trigger("blur"), _("locationText") && P("locationText", e.label) } if (e && "" != e) oe.ajax({ url: ae + "/lookup/city?locationId=" + e, success: function (e) { e.result && e.result.value && e.result.label && (t.attr("data-value", e.result.value).data("data-object", e.result).val(e.result.label).trigger("blur"), _("locationText") && P("locationText", e.result.label)) } }); else { if (t.hasClass("noAutolookup")) return !1; oe.ajax({ url: ae + "/lookup/currentCity", success: function (e) { e.result && e.result.value && e.result.label ? a(e.result) : a(n) }, error: function () { a(n) } }) } }), _("cigaretteBrand") && 0 < j("cigaretteBrand").length ? (o = "cigaretteBrand", r = function (e) { P("cigaretteType", null) }, c.find("input[name='" + o + "'], .formio-lookup-" + o).ubeAutocomplete({ position: { my: "left top", at: "left bottom", collision: "none" }, classes: { "ui-autocomplete": "max-height" }, source: function (e, t) { oe.ajax({ url: ae + "/lookup/brands/family", data: { query: e.term }, success: function (e) { t(e.result) } }) }, minLength: 0, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.value), c.find(".ube-label-" + o).html(t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur"), r && r(t.item.value) }, focus: C, change: k }).each(S(o)), a = "cigaretteType", i = "cigaretteBrand", e = !0, t = c.find("input[name='" + a + "'], .formio-lookup-" + a).ubeAutocomplete({ position: { my: "left top", at: "left bottom", collision: "none" }, classes: { "ui-autocomplete": "max-height" }, source: function (e, t) { oe.ajax({ url: ae + "/lookup/brands/sku", data: { query: e.term, familyId: i ? R(i) : void 0 }, success: function (e) { t(e.result) } }) }, minLength: 0, select: function (e, t) { e.preventDefault(), oe(this).attr("data-value", t.item.value), c.find(".ube-label-" + a).html(t.item.label), oe(this).data("data-object", t.item), oe(this).val(t.item.label).trigger("blur") }, focus: C, change: k }).each(S(a)), e && t.focus(function () { oe(this).autocomplete("search", "") })) : A("cigaretteType"), Q && -1 < Q.indexOf("pone") ? A("cigaretteTypeExt", !0, !0, !0) : A("cigaretteTypeExt"), te.off("click", ".ube-trigger-event").on("click", ".ube-trigger-event", function (e) { if (e.preventDefault(), H) return !1; var t = oe(this).attr("data-ube-event"); de("UBE", t, V); var n, a, i, o, r, s, u, l = ie, c = q(); if ("resendCode" == t || "resendPhoneCode" == t || "resendEmailCode" == t) oe.ajax({ url: ae + "/resendCode", headers: { "ube-session-key": Z }, data: { form: V, entity: l.entity || V, submissionId: l.submissionId, profileId: c.profileId, event: t }, success: function (e) { e.message ? Y(e.message) : e.error && Y(e.error) } }); else if (-1 < t.indexOf("social-login-")) { oe(".ube-validation-message-show-for-social-login").hide(), z(!0), de("Social-Login", "Show-Login", f = t.substring(13)), oe.get(ae + "/auth/" + V + "/" + f + "/url", { sessionKey: Z }).done(function (e) { window.location.href = e.authorizationUrl }) } else if (-1 < t.indexOf("social-popup-login-")) { de("Social-Login", "Shop-Popup", f = t.substring(19)), Ee(f, Z, V, ae, function (e, t) { t && t.socialId && (P("socialId", t.socialId), P("socialKey", f)); var n = l.entity || V; Ve(t, n) }) } else if (-1 < t.indexOf("social-set-")) { de("Social-Attach", "Shop-Popup", f = t.substring(11)); var d = oe(this).attr("data-ube-url"); Ee(f, Z, V, ae, function (e) { var t; e && ("vk" === f ? (t = "vkontakte", e = "id" + e) : t = f, f && P(t, e)) }, d) } else if (-1 < t.indexOf("optin-cancel-")) { var f = t.substring(13); if (-1 === ["email", "phone", "cross"].indexOf(f)) return; P(f + "CodeSent", !1), P(f + "ValidatedValue", ""), P(f + "CodeSentAt", null), P("submitted" + Ae(f) + "Code", null), L("submitted" + Ae(f) + "Code"), W() } else if (-1 < t.indexOf("optin-validate-")) { f = t.substring(15); if (-1 === ["email", "phone", "cross"].indexOf(f)) return; L("submitted" + Ae(f) + "Code"), n = ["firstName"], a = ["optinValidate" + Ae(f)], i = function () { return $(f, function () { var e = { firstName: c.firstName, userId: c.userId }; e[f] = c[f], z(!0), oe.ajax({ url: ne + "/esb/" + V + "/validate" + (Z ? "?sessionKey=" + Z : ""), method: "post", data: JSON.stringify(e), contentType: "application/json; charset=UTF-8", success: function (e) { var t; z(!1), e.sessionKey && (Z = e.sessionKey), e.result ? (R(f + "ValidatedValue") !== R(f) && P("submitted" + Ae(f) + "Code", null), P(f + "CodeSent", !0), P(f + "ValidatedValue", c[f]), P(f + "CodeSentAt", (new Date).getTime()), t = "is" + Ae(f) + "Cross", e.sessionData && _(t) && P(t, e.sessionData[t]), W(), j(f).trigger("optin-started")) : e.error ? (Y(e.error), P(f + "CodeSent", !1), P(f + "ValidatedValue", ""), P(f + "CodeSentAt", null), P("submitted" + Ae(f) + "Code", null), W()) : e.fields && e.fields[f] && !1 === e.fields[f].result && e.fields[f].message && (P(f + "CodeSent", !1), P(f + "ValidatedValue", ""), P(f + "CodeSentAt", null), P("submitted" + Ae(f) + "Code", null), B(f, c[f], e.fields[f].message)) }, error: function () { z(!1) } }) }, function () { }) }, r = a.map(function (e) { return M(e) || [] }).flat(), s = me(new Set(r.concat(n || []))).filter(_), u = {}, s.forEach(function (e) { return $(e, function (e) { u[e] = !0, h() }, function (e) { u[e] = !1, h() }) }) } else X.onSubmissionSuccess && X.onSubmissionSuccess(l.submissionId, l.userId, { event: t, data: { data: l, sessionKey: Z } }); function h() { s.every(function (e) { return !0 === u[e] }) ? i && i(s) : s.every(function (e) { return !0 === u[e] || !1 === u[e] }) && o && o(s.filter(function (e) { return !u[e] }), s.filter(function (e) { return u[e] })) } e.preventDefault() }), c.ubeTraverseEnter(), E && (u = 0, s = x.components.filter(function (e) { return "panel" == e.type }), f = s.map(function (e) { return e.key }), h = s.length, p = function (s) { return function (e) { var t, n, a, i, o, r; return t = s, n = oe(this), a = e, h <= (r = u + t) ? c.submit() : 0 <= r && (i = f[u], o = function () { var e; X.onStepChange ? X.onStepChange(r, u, n, a) : (e = f[u], G(i, !1), G(e, !0)), u = r }, 0 < t ? J(o, null, N(i)) : o()), e.preventDefault(), !1 } }, c.find(".ube-wizard-next").click(p(1)), c.find(".ube-wizard-prev").click(p(-1)), te.add(c).on("ubeNext", p(1)).on("ubePrev", p(-1))), te.data("ube", { appendChildrenKeys: N, validateAllFields: J, validateComponent: $, sessionKey: Z }), _("firstName") && _("lastName") && Oe(), te.find("[autocomplete='off'], [autocomplete='false'], [autocomplete='disabled'], [autocomplete='no']").disableBrowserAutocomplete(), X.onFormLoad && X.onFormLoad(), c.trigger("formLoaded"), 0 < te.find(".g-recaptcha").length ? T() : O.grecaptcha && 0 < O.grecaptcha.length ? (c.append('<div class="g-recaptcha" data-sitekey="' + O.grecaptcha + '" data-size="invisible"></div>'), T()) : te.removeAttr("withReCaptcha") } var a, r = X.template || ""; 0 == r.length && (!/retail/.test(V) && /-(idx|reg|optin|av|login|remind|cabinet|phone|phone-send|phone-check)$/.test(V) || te.is(":empty")) && (r = ne + "/template/" + V), !(X.isTemplatePreloaded && !((a = V) && -1 < ye.indexOf(a))) && 0 < r.length && (!/(retail)/.test(r) || te.is(":empty")) ? te.load(r, n) : n() } return Z && !1 !== X.loadFormDataFromSession ? oe.when(oe.getJSON(Q), oe.getJSON(a)).then(function (e, t) { n(t[0]), i(e[0]), t && t.error && X.onSessionError && X.onSessionError(t.error, Z) }) : X.formDefinitionJson ? i(X.formDefinitionJson) : oe.getJSON(Q).done(i).fail(Se), this }, oe(document).ready(function () { var e, t, n; window.setTimeout(function () { var a, i, e, t; ue(te) || (v(), a = encodeURIComponent(window.location.hostname), i = encodeURIComponent(window.location.pathname), e = "" + (new Date).getTime(), ue(ne, e), ue(ne) == e && (ue(ne, null), oe.get(oe.ube.host + "/api/cookie/popup?host=" + a + "&path=" + i).done(function (e) { var t, n; e && e.showCookie && e.template ? ((t = oe(e.template)).hide().appendTo(oe("body")).not("script, style").fadeIn(400), oe(".cookie-confirm-button").click(function () { ue(te, "CONFIRMED"), oe.get(oe.ube.host + "/api/cookie/track?host=" + a + "&path=" + i), setTimeout(function () { t.not("script, style").fadeOut(400) }, 1e3), de("UBE-Cookie", "Agree") }), de("UBE-Cookie", "Show")) : (n = new Date((new Date).getTime() + 864e5), ue(te, "DOMAIN_DISABLED", n.toUTCString())) }))), (t = Ie()).utm_content && Te("utmContent", t.utm_content), t.utm_campaign && Te("utmCampaign", t.utm_campaign), t.utm_source && Te("utmSource", t.utm_source), t.utm_medium && Te("utmMedium", t.utm_medium) }, 100), v(), e = window.location.pathname, t = window.location.hostname, n = new M(t, e), X.forEach(function (e) { return e.isDefinedAt(n) && e.launch(n) }) }) }(jQuery);